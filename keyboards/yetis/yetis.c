/*
 * Copyright 2023 Norbert Pocs (norbertpocs0@gmail.com, jogme)
 * SPDX-License-Identifier: GPL-2.0-or-later
 */

#include "quantum.h"

#ifdef OLED_ENABLE
/* corresponds to the layer number in keymaps/default/keymap.c */
#define LAYER_GAME 4
oled_rotation_t oled_init_kb(oled_rotation_t rotation) {
    if (!is_keyboard_master()) {
        return OLED_ROTATION_90;
    }
    return OLED_ROTATION_270;
}

static void render_logo(void) {
    const char yeti_logo [] = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x40, 0x40, 0xc0, 0x40, 0x40, 0x00, 0x00, 0x40, 0x40, 0x40, 0xc0, 0x00, 0x00, 0x00,
        0x40, 0x40, 0x40, 0x40, 0xc0, 0x80, 0x00, 0x00, 0x00, 0xc0, 0xf0, 0x98, 0x18, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x5f, 0x18, 0x10, 0x00, 0x00, 0x00, 0x10, 0x10, 0x7f, 0x10, 0x10, 0x00,
        0x06, 0x0e, 0x12, 0x12, 0x0a, 0x0f, 0x00, 0x00, 0x1e, 0x03, 0x00, 0x07, 0x1c, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x60, 0xe0, 0xf0, 0xf0, 0xe0, 0xf0, 0xf0, 0xf0, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0xc1, 0xf3, 0x33, 0x03, 0x03, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00,
        0x83, 0xff, 0xff, 0x07, 0x23, 0xf3, 0xe7, 0x87, 0x0f, 0x07, 0x07, 0x03, 0x03, 0x03, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x1e, 0xff, 0xff, 0x86, 0x03, 0xc0, 0xf1, 0xff, 0xff, 0xfe, 0xfe, 0xfe,
        0xff, 0xff, 0xfd, 0xe0, 0x86, 0xff, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x02, 0x07, 0x07, 0x0f, 0x0f, 0x0f, 0x2f, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0x2f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01,
        0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };

    oled_write_raw_P(yeti_logo, sizeof(yeti_logo));
}

static void oled_render_caps_lock(void) {
    led_t l = host_keyboard_led_state();
    oled_write_ln(l.caps_lock ? PSTR("Caps Lock") : PSTR(" \n"), false);
}

static void oled_render_layer_state(void) {
    switch (get_highest_layer(layer_state)) {
        case LAYER_GAME:
            oled_write_ln(PSTR("GAME"), false);
            break;
        default:
            oled_write_ln(PSTR(" \n"), false);
    }
}

static void oled_render_mods(void) {
    static uint8_t mods;
    mods = get_mods() | get_oneshot_mods();
    if (mods & MOD_MASK_SHIFT) {
        oled_write_ln(PSTR("Shft"), false);
    } else {
        oled_write_ln(PSTR(" "), false);
    }
    if (mods & MOD_MASK_CTRL) {
        oled_write_ln(PSTR("Ctrl"), false);
    } else {
        oled_write_ln(PSTR(" "), false);
    }
    if (mods & MOD_MASK_ALT) {
        oled_write_ln(PSTR("Alt"), false);
    } else {
        oled_write_ln(PSTR(" "), false);
    }
    if (mods & MOD_MASK_GUI) {
        oled_write_ln(PSTR("Win"), false);
    } else {
        oled_write_ln(PSTR(" "), false);
    }
}

bool oled_task_kb(void) {
    if (!oled_task_user()) {
        return false;
    }
    if (!is_keyboard_master()) {
        render_logo();
    } else {
        oled_write_ln(PSTR("yeti\n"), false);
        oled_render_mods();
        oled_render_caps_lock();
        oled_render_layer_state();
    }

    return false;
}
#endif
